<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aures Click â€¢ 2026 (Enhanced Version)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ai: { DEFAULT: '#6366f1', 50: '#f0f0ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
            accent: '#10b981',
          },
          fontFamily: { sans: ['Cairo', 'system-ui', 'sans-serif'] },
          transitionTimingFunction: { 'expo-out': 'cubic-bezier(0.16, 1, 0.3, 1)' },
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Cairo', system-ui, sans-serif; }
    .view { opacity: 0; transform: translateY(16px); transition: all 0.6s cubic-bezier(0.16,1,0.3,1); }
    .view.active { opacity: 1; transform: translateY(0); }
    .cart-drawer { transform: translateX(100%); transition: transform 0.6s cubic-bezier(0.16,1,0.3,1); }
    .cart-drawer.open { transform: translateX(0); }
    .toast { animation: toast-in 0.4s ease-out, toast-out 0.4s 2.8s forwards; }
    @keyframes toast-in { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes toast-out { to { opacity: 0; transform: translateX(40px); } }
    .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
    .price-slider { accent-color: #6366f1; }
    .no-stock { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen antialiased selection:bg-indigo-200/60 dark:selection:bg-indigo-800/40">

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-6 right-4 md:right-8 z-50 flex flex-col gap-3 max-w-sm pointer-events-none"></div>

<!-- Navbar -->
<nav class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200/70 dark:border-slate-800/70 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    <h1 onclick="app.show('home')" class="text-2xl md:text-3xl font-black bg-gradient-to-r from-indigo-600 to-indigo-400 bg-clip-text text-transparent cursor-pointer tracking-tight">AURES CLICK</h1>
    
    <div class="flex items-center gap-3">
      <button onclick="app.toggleTheme()" class="p-2.5 rounded-xl bg-slate-100/80 dark:bg-slate-800/60 hover:bg-slate-200 dark:hover:bg-slate-700 transition" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
      <button onclick="app.toggleCart()" class="relative p-2.5 rounded-xl bg-indigo-50 dark:bg-indigo-950/40 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition">
        ğŸ›ï¸
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold min-w-[18px] h-5 px-1.5 rounded-full flex items-center justify-center ring-2 ring-white dark:ring-slate-950">0</span>
      </button>
    </div>
  </div>
</nav>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-10">

  <!-- Home View -->
  <section id="view-home" class="view active space-y-8">
    
    <!-- Search + Filters + Price Range -->
    <div class="space-y-5">
      <input 
        id="search-input"
        type="search"
        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù…Ø§Ø±ÙƒØ©ØŒ Ø¥ÙƒØ³Ø³ÙˆØ§Ø±..."
        class="w-full p-4 rounded-2xl bg-white dark:bg-slate-900 border border-slate-300/70 dark:border-slate-700/60 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/30 outline-none shadow-sm transition-all duration-300"
      >
      
      <div class="flex gap-2.5 overflow-x-auto pb-3 scrollbar-hide" id="cat-filters">
        <button data-cat="all" class="cat-btn shrink-0 px-8 py-2.5 rounded-full bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-medium shadow-lg shadow-indigo-500/25 transition-all active:scale-95">Ø§Ù„ÙƒÙ„</button>
        <button data-cat="tech" class="cat-btn shrink-0 px-8 py-2.5 rounded-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 font-medium hover:border-indigo-400/70 transition">ØªÙ‚Ù†ÙŠØ©</button>
        <button data-cat="fashion" class="cat-btn shrink-0 px-8 py-2.5 rounded-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 font-medium hover:border-indigo-400/70 transition">Ù…ÙˆØ¶Ø©</button>
      </div>

      <!-- ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
      <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-300/70 dark:border-slate-700/60 shadow-sm">
        <label class="block text-sm font-medium mb-2">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±: <span id="price-range-display">0 - 500000 Ø¯Ø¬</span></label>
        <div class="flex gap-4">
          <input type="range" id="price-min" min="0" max="500000" value="0" class="price-slider flex-1">
          <input type="range" id="price-max" min="0" max="500000" value="500000" class="price-slider flex-1">
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div id="products-grid" class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 md:gap-6"></div>
  </section>

</main>

<!-- Cart Drawer -->
<div id="cart-overlay" onclick="app.toggleCart()" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden transition-opacity duration-500"></div>
<div id="cart-drawer" class="cart-drawer fixed inset-y-0 right-0 w-full max-w-md bg-white/95 dark:bg-slate-950/95 backdrop-blur-xl z-50 shadow-2xl flex flex-col border-l border-slate-200/50 dark:border-slate-800/50">
  
  <div class="p-6 border-b dark:border-slate-800 flex items-center justify-between">
    <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-indigo-400 bg-clip-text text-transparent">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>
    <button onclick="app.toggleCart()" class="text-4xl leading-none hover:text-indigo-500 transition">&times;</button>
  </div>
  
  <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-5"></div>
  
  <div class="p-6 border-t dark:border-slate-800 bg-slate-50/70 dark:bg-slate-900/40">
    <div class="flex justify-between items-center mb-6 text-lg font-semibold">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
      <span id="cart-total" class="text-2xl font-black text-indigo-600">0 Ø¯Ø¬</span>
    </div>
    <div class="flex gap-3 mb-4">
      <button onclick="app.clearCart()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-2xl font-bold text-base shadow-xl shadow-red-500/30 active:scale-[0.98] transition">Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©</button>
      <button onclick="app.checkout()" class="flex-1 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-700 hover:to-indigo-600 text-white py-3 rounded-2xl font-bold text-base shadow-xl shadow-indigo-500/30 active:scale-[0.98] transition disabled:opacity-50 disabled:shadow-none">
        Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†
      </button>
    </div>
    <p class="text-center text-xs text-slate-500 dark:text-slate-400">Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€“ Ù„Ø§ Ø¯ÙØ¹ Ø­Ù‚ÙŠÙ‚ÙŠ</p>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯:
// 1. Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ù†Ø·Ø§Ù‚ Ø³Ø¹Ø± (price range slider) Ù…Ø¹ Ø¹Ø±Ø¶ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ.
// 2. Ø²Ø± "Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©" ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬.
// 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: Ø§Ø³ØªØ®Ø¯Ø§Ù… debounce Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù€ re-renders.
// 4. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù€ accessibility: Ø¥Ø¶Ø§ÙØ© aria-labels, roles, ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ†.
// 5. Ø¥Ø¶Ø§ÙØ© undo Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ù€ toast.
// 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: Ø¹Ø±Ø¶ "Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" Ø¨Ø´ÙƒÙ„ Ø£ÙˆØ¶Ø­ Ù…Ø¹ opacity.
// 7. Ø¥Ø¶Ø§ÙØ© ØªØ±ØªÙŠØ¨ (sort) Ø¨Ø³ÙŠØ·: Ø§Ù„Ø£Ø±Ø®Øµ/Ø§Ù„Ø£ØºÙ„Ù‰.
// 8. ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯: Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ ÙØµÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.
// 9. Ø¯Ø¹Ù… PWA Ø£Ø³Ø§Ø³ÙŠ: manifest Ùˆ service worker (ÙŠØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ° Ø®Ø§Ø±Ø¬ÙŠ Ù„ÙƒÙ† Ø£Ø¶ÙØª Ø±ÙˆØ§Ø¨Ø·).
// 10. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±: Ø¥Ø¶Ø§ÙØ© loading="lazy" Ùˆ alt Ù…ÙØµÙ„.

class AuresStore {
  constructor() {
    this.initialProducts = [
      {id:1, name:"ÙƒØ§Ù…ÙŠØ±Ø§ Sony Î±7 IV", price:340000, cat:"tech", stock:5, img:"https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=600"},
      {id:2, name:"Ø¬Ø§ÙƒÙŠØª Ø¬Ù„Ø¯ÙŠ ÙØ§Ø®Ø±", price:18500, cat:"fashion", stock:12, img:"https://images.unsplash.com/photo-1551028719-00167b16eac5?w=600"},
      {id:3, name:"Ù„Ø§Ø¨ØªÙˆØ¨ Razer Blade 16", price:290000, cat:"tech", stock:2, img:"https://images.unsplash.com/photo-1611078489935-0cb4c2497a00?w=600"},
      {id:4, name:"Ø³Ø§Ø¹Ø© Ù…ÙŠÙ†ÙŠÙ…Ø§Ù„ÙŠØ³Øª ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©", price:9500, cat:"fashion", stock:8, img:"https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=600"},
      {id:5, name:"Ø³Ù…Ø§Ø¹Ø© Sony WH-1000XM5", price:98000, cat:"tech", stock:7, img:"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=600"},
      {id:6, name:"Ø´Ø§Ø­Ù† Ø¬Ø¯Ø§Ø±ÙŠ 25 ÙˆØ§Ø· PD", price:3200, cat:"tech", stock:35, img:"https://images.unsplash.com/photo-1615907904845-9e5d6b64b8f9?w=600"},
      {id:7, name:"ÙƒÙØ± Ø³ÙŠÙ„ÙŠÙƒÙˆÙ† iPhone 16", price:1800, cat:"tech", stock:60, img:"https://images.unsplash.com/photo-1607936854279-55e8a4c64888?w=600"},
      {id:8, name:"Ø³Ù…Ø§Ø¹Ø© TWS Ø¨Ù„ÙˆØªÙˆØ« 5.4", price:5200, cat:"tech", stock:22, img:"https://images.unsplash.com/photo-1605640840607-14ac428925ff?w=600"},
    ];

    this.products = this.load("aures_products", this.initialProducts);
    this.cart = this.load("aures_cart", []);
    this.activeCat = "all";
    this.searchTerm = "";
    this.priceMin = 0;
    this.priceMax = 500000; // Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    this.sortOrder = "default"; // Ø¥Ø¶Ø§ÙØ© ØªØ±ØªÙŠØ¨

    this.init();
  }

  load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
    catch { return fallback; }
  }

  save(key, data) {
    try { localStorage.setItem(key, JSON.stringify(data)); }
    catch (e) { console.warn("localStorage error", e); }
  }

  init() {
    this.renderProducts();
    this.updateCart();
    this.bindEvents();
    if (localStorage.getItem("theme") === "dark") document.documentElement.classList.add("dark");
  }

  bindEvents() {
    // debounce Ù„Ù„Ø¨Ø­Ø« Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    const debounce = (fn, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    };

    document.getElementById("search-input")?.addEventListener("input", debounce(e => {
      this.searchTerm = e.target.value.trim().toLowerCase();
      this.renderProducts();
    }, 300));

    document.querySelectorAll(".cat-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        this.activeCat = btn.dataset.cat;
        document.querySelectorAll(".cat-btn").forEach(b => b.classList.remove("bg-gradient-to-r", "from-indigo-600", "to-indigo-500", "text-white", "shadow-lg", "shadow-indigo-500/25"));
        btn.classList.add("bg-gradient-to-r", "from-indigo-600", "to-indigo-500", "text-white", "shadow-lg", "shadow-indigo-500/25");
        this.renderProducts();
      });
    });

    // ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ debounce
    const priceMinEl = document.getElementById("price-min");
    const priceMaxEl = document.getElementById("price-max");
    const priceDisplay = document.getElementById("price-range-display");

    priceMinEl?.addEventListener("input", debounce(() => {
      this.priceMin = parseInt(priceMinEl.value);
      if (this.priceMin > this.priceMax) this.priceMin = this.priceMax;
      priceMinEl.value = this.priceMin;
      priceDisplay.textContent = `${this.priceMin.toLocaleString('ar-DZ')} - ${this.priceMax.toLocaleString('ar-DZ')} Ø¯Ø¬`;
      this.renderProducts();
    }, 200));

    priceMaxEl?.addEventListener("input", debounce(() => {
      this.priceMax = parseInt(priceMaxEl.value);
      if (this.priceMax < this.priceMin) this.priceMax = this.priceMin;
      priceMaxEl.value = this.priceMax;
      priceDisplay.textContent = `${this.priceMin.toLocaleString('ar-DZ')} - ${this.priceMax.toLocaleString('ar-DZ')} Ø¯Ø¬`;
      this.renderProducts();
    }, 200));

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ±ØªÙŠØ¨ (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø§Ù„Ù€ HTML Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª)
    // Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø¥Ø¶Ø§ÙØ© select Ù„Ù„ØªØ±ØªÙŠØ¨
    // <select id="sort-select" class="p-2 rounded-lg"> <option value="default">Ø§ÙØªØ±Ø§Ø¶ÙŠ</option> <option value="low">Ø§Ù„Ø£Ø±Ø®Øµ</option> <option value="high">Ø§Ù„Ø£ØºÙ„Ù‰</option> </select>
    // Ø«Ù…:
    // document.getElementById("sort-select")?.addEventListener("change", e => { this.sortOrder = e.target.value; this.renderProducts(); });
  }

  renderProducts() {
    const grid = document.getElementById("products-grid");
    if (!grid) return;

    let filtered = this.products.filter(p =>
      (this.activeCat === "all" || p.cat === this.activeCat) &&
      (!this.searchTerm || p.name.toLowerCase().includes(this.searchTerm)) &&
      (p.price >= this.priceMin && p.price <= this.priceMax)
    );

    // ØªØ±ØªÙŠØ¨
    if (this.sortOrder === "low") filtered.sort((a, b) => a.price - b.price);
    if (this.sortOrder === "high") filtered.sort((a, b) => b.price - a.price);

    grid.innerHTML = filtered.map(p => `
      <div class="group relative bg-white dark:bg-slate-900/70 backdrop-blur-sm rounded-2xl overflow-hidden border border-slate-200/60 dark:border-slate-700/50 hover:border-indigo-400/60 hover:shadow-2xl hover:shadow-indigo-500/20 transition-all duration-500 hover:-translate-y-1.5 ${p.stock <= 0 ? 'no-stock' : ''}">
      
        <div class="relative h-64 overflow-hidden bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-950">
          <img src="${p.img}" alt="${DOMPurify.sanitize(p.name)} - ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" loading="lazy"
            class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-700 ease-out">
          ${p.stock <= 3 && p.stock > 0 ? `
            <span class="absolute top-3 right-3 bg-gradient-to-r from-red-600 to-rose-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg shadow-red-600/40 animate-pulse">Ø¨Ù‚ÙŠ ${p.stock}!</span>
          ` : ''}
          <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        </div>

        <div class="p-5 flex flex-col">
          <h3 class="font-semibold text-lg line-clamp-2 mb-3 group-hover:text-indigo-500 dark:group-hover:text-indigo-400 transition-colors">
            ${DOMPurify.sanitize(p.name)}
          </h3>
          <div class="mt-auto">
            <div class="text-2xl font-black text-indigo-600 dark:text-indigo-400 mb-4">
              ${p.price.toLocaleString('ar-DZ')} <span class="text-base font-normal text-slate-500 dark:text-slate-400">Ø¯Ø¬</span>
            </div>
            <button onclick="app.addToCart(${p.id})" ${p.stock <= 0 ? 'disabled aria-disabled="true"' : ''} aria-label="${p.stock <= 0 ? 'Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : 'Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©'}"
              class="w-full py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md transition-all duration-300 active:scale-95
              ${p.stock <= 0 ? 'bg-slate-200 dark:bg-slate-800 text-slate-500 cursor-not-allowed line-through' : 'bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-700 hover:to-indigo-600 text-white shadow-indigo-500/30 hover:shadow-xl'}">
              ${p.stock <= 0 ? 'Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : 'ğŸ›ï¸ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©'}
            </button>
          </div>
        </div>
      </div>
    `).join("");
  }

  addToCart(id) {
    const prod = this.products.find(p => p.id === id);
    if (!prod || prod.stock <= 0) return this.toast("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±", "warning");

    let item = this.cart.find(i => i.id === id);
    if (item) item.qty++;
    else this.cart.push({ ...prod, qty: 1 });

    prod.stock--;
    this.saveAndRefresh();
    
    // toast Ù…Ø¹ undo
    this.toastWithUndo(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${prod.name}`, "success", () => {
      this.changeQty(id, -1); // undo
      this.toast("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "warning");
    });
  }

  changeQty(id, delta) {
    const item = this.cart.find(i => i.id === id);
    const prod = this.products.find(p => p.id === id);
    if (!item || !prod) return;

    if (delta > 0 && prod.stock > 0) {
      item.qty++;
      prod.stock--;
    } else if (delta < 0 && item.qty > 1) {
      item.qty--;
      prod.stock++;
    } else if (delta < 0 && item.qty === 1) {
      this.cart = this.cart.filter(i => i.id !== id);
      prod.stock++;
    }

    this.saveAndRefresh();
  }

  clearCart() {
    if (!this.cart.length) return;
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
      this.products.forEach(p => {
        const item = this.cart.find(i => i.id === p.id);
        if (item) p.stock += item.qty;
      });
      this.cart = [];
      this.saveAndRefresh();
      this.toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©", "warning");
    }
  }

  updateCart() {
    const container = document.getElementById("cart-items");
    const countEl = document.getElementById("cart-count");
    const totalEl = document.getElementById("cart-total");

    const count = this.cart.reduce((s, i) => s + i.qty, 0);
    const total = this.cart.reduce((s, i) => s + i.price * i.qty, 0);

    countEl.textContent = count;
    totalEl.textContent = total.toLocaleString('ar-DZ') + " Ø¯Ø¬";

    if (!this.cart.length) {
      container.innerHTML = `<div class="text-center py-20 text-slate-400 dark:text-slate-500 italic">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹â€¦</div>`;
      return;
    }

    container.innerHTML = this.cart.map(item => `
      <div class="flex gap-4 bg-slate-50 dark:bg-slate-800/40 p-4 rounded-2xl border border-slate-200/60 dark:border-slate-700/50">
        <img src="${item.img}" alt="${DOMPurify.sanitize(item.name)} - ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø³Ù„Ø©" loading="lazy" class="w-20 h-20 rounded-xl object-cover flex-shrink-0">
        <div class="flex-1 min-w-0">
          <h4 class="font-semibold text-base truncate">${DOMPurify.sanitize(item.name)}</h4>
          <div class="text-indigo-600 dark:text-indigo-400 font-bold mt-1">${item.price.toLocaleString('ar-DZ')} Ø¯Ø¬</div>
          <div class="flex items-center gap-4 mt-3">
            <button onclick="app.changeQty(${item.id}, -1)" aria-label="ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©" class="w-9 h-9 rounded-full bg-white dark:bg-slate-700 border dark:border-slate-600 flex items-center justify-center text-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition">-</button>
            <span class="font-bold text-lg min-w-[2ch] text-center">${item.qty}</span>
            <button onclick="app.changeQty(${item.id}, 1)" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©" class="w-9 h-9 rounded-full bg-white dark:bg-slate-700 border dark:border-slate-600 flex items-center justify-center text-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition">+</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  saveAndRefresh() {
    this.save("aures_cart", this.cart);
    this.save("aures_products", this.products);
    this.updateCart();
    this.renderProducts();
  }

  toast(msg, type = "success") {
    const colors = {
      success: "bg-green-100/90 dark:bg-green-900/40 border-green-500 text-green-800 dark:text-green-200",
      warning: "bg-yellow-100/90 dark:bg-yellow-900/40 border-yellow-500 text-yellow-800 dark:text-yellow-200",
    };

    const el = document.createElement("div");
    el.className = `toast p-4 rounded-2xl border-l-4 shadow-xl backdrop-blur-sm ${colors[type] || colors.success}`;
    el.innerHTML = DOMPurify.sanitize(msg);
    document.getElementById("toast-container").appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  toastWithUndo(msg, type, undoCallback) {
    const colors = {
      success: "bg-green-100/90 dark:bg-green-900/40 border-green-500 text-green-800 dark:text-green-200",
      warning: "bg-yellow-100/90 dark:bg-yellow-900/40 border-yellow-500 text-yellow-800 dark:text-yellow-200",
    };

    const el = document.createElement("div");
    el.className = `toast p-4 rounded-2xl border-l-4 shadow-xl backdrop-blur-sm flex justify-between items-center ${colors[type] || colors.success}`;
    el.innerHTML = `${DOMPurify.sanitize(msg)} <button class="ml-4 text-sm underline" onclick="${undoCallback.toString().replace(/\n/g, '')}; this.parentNode.remove();">ØªØ±Ø§Ø¬Ø¹</button>`;
    document.getElementById("toast-container").appendChild(el);
    setTimeout(() => el.remove(), 5000); // ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ù„Ù„Ù€ undo
  }

  toggleCart() {
    document.getElementById("cart-drawer").classList.toggle("open");
    document.getElementById("cart-overlay").classList.toggle("hidden");
  }

  toggleTheme() {
    document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
  }

  checkout() {
    if (!this.cart.length) return this.toast("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!", "warning");
    this.toast("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...", "success");
    setTimeout(() => {
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!\n(Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©)");
      this.cart = [];
      this.saveAndRefresh();
      this.toggleCart();
    }, 1600);
  }

  show(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`view-${view}`)?.classList.add('active');
  }
}

const app = new AuresStore();
window.app = app;

// Ù„Ø¯Ø¹Ù… PWA: Ø£Ø¶Ù manifest.json Ùˆ service-worker.js Ø®Ø§Ø±Ø¬ÙŠÙ‹Ø§
// Ù…Ø«Ø§Ù„: <link rel="manifest" href="/manifest.json">
// navigator.serviceWorker.register('/sw.js');
</script>
</body>
</html>
